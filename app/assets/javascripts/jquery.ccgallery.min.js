/* CCGallery - HTML5 Multimedia Gallery - 3.0.1
 * Copyright 2012, Nilok Bose
 * http://codecanyon.net/user/cosmocoder
*/

jQuery(function(d){var o=d("#ccgallery"),k=d("#thumbGallery"),l=d("#thumbGallery").find("ul"),j=d("#itemList"),c=d("#coverflowGallery"),e=d("#coverContainer"),i=d.browser.msie?true:false,a=i&&d.browser.version<9&&IE7.recalc?true:false,n="config.xml",f=o.data("autoplay")===true?true:false,h=o.data("loop")===true?true:false;if(o.data("mobile")===true){d.ajax({type:"GET",url:"includes/mobile.php",dataType:"text",success:function(p){if(p==="true"){n="config-mobile.xml"}g()}})}else{g()}function g(){d.ajax({type:"GET",url:n,dataType:"xml",success:function(p){m(d(p))}})}function m(B){var p=B.find("file"),u=p.find("cover"),t=p.find("thumb"),s=p.find("title"),x=p.find("description"),A=p.length,r=0;var w="",D="",C="";for(var v=0;v<A;v++){var z=p.eq(v).find("category"),y='{"category": false}';if(z.length!==0){y="{";z.each(function(){y+='"'+d(this).text()+'": true,'});y=y.substr(0,y.length-1);y+="}"}w+='<li data-id="'+(v+1)+'" data-type="'+p.eq(v).attr("type")+"\" data-categories='"+y+"'>";w+='<img src="'+t.eq(v).text()+'" alt="" />';w+='<div class="details">';w+="<h2>"+s.eq(v).text()+"</h2>";w+='<p class="description">'+x.eq(v).text()+"</p>";w+="</div>";w+="</li>";D+='<img src="'+u.eq(v).text()+'" alt="" />';C+='<li data-id="'+(v+1)+'" data-type="'+p.eq(v).attr("type")+"\" data-categories='"+y+"'>";C+="<h2>"+s.eq(v).text()+"</h2>";C+='<p class="description">'+x.eq(v).text()+"</p>";C+="</li>"}l.html(w);e.html(D);j.html(C);if(a){j.delegate("li","mouseleave click",function(E){d(this).removeClass("ie7_class7")});l.delegate("li","mouseleave",function(E){d(this).removeClass("ie7_class4")})}var q;if(d("#gocoverflow").hasClass("active")){q="coverflow"}else{q="thumbnails";if(i){o.find("section").css({position:"absolute",top:"0",left:"0"});c.css({display:"block",opacity:"0"})}}o.find("img").load(function(){r++;if(r===2*A){o.css({height:"auto",background:"none"});if(q==="coverflow"){e.parent().fadeIn(600)}else{k.fadeIn(600);if(i){o.find("section").css("position","static");c.css({display:"none",opacity:"1"})}}b(A,p)}})}function b(z,w){var S=l.clone(),M=j.clone(),P=100;if(i&&d.browser.version==9){var A=d('<div id="olfix"/>').insertAfter(j)}o.find("menu").delegate("a.navbuttons","click",function(){var az=d(this),av=az.index(),aA=d("section.displayStyle"),aw=az.data("type"),ax=az.data("category");az.addClass("active").siblings().removeClass("active");if(az.parent().is("#sortButtons")){var au,ay;if(aw){if(aw==="all"){au=S.find("li");ay=M.find("li")}else{au=S.find("li[data-type="+aw+"]");ay=M.find("li[data-type="+aw+"]")}}else{if(ax){au=S.find("li").filter(function(){if(ax in d(this).data("categories")){return true}});ay=M.find("li").filter(function(){if(ax in d(this).data("categories")){return true}})}}l.quicksand(au,{duration:P,adjustHeight:"dynamic",useScaling:false},function(){l.css("height","auto");if(a){IE7.recalc()}});j.quicksand(ay,{duration:P,adjustHeight:"dynamic",useScaling:false},function(){j.css("height","auto");V();if(a){IE7.recalc()}if(A){A[0].innerHTML=" "}})}else{if(aA.eq(av).is(":visible")){return false}else{aA.filter(":visible").fadeOut(600,function(){aA.eq(av).fadeIn(600)})}}});d("#sortButtons").find("a.active").not('[data-type="all"]').trigger("click");P=800;var aj;l.delegate("img","click",function(){var ay=d(this).parent(),au=ay.data("id")-1,aw=ay.data("type"),ax=w.eq(au).find("link").text(),av=w.eq(au).find("source"),az="thumb";aj=l.find("img").index(this);if(ax){window.location.href=ax}else{ag(az,aw,av,ay.find("h2")[0].innerHTML,ay.find("p")[0].innerHTML)}});var aq=e.find("img"),W=d('<div class="cwrapper"/>').appendTo(e).hide(),R=d('<canvas class="fade"/>').appendTo(e),I=d('<p id="coverTitle"/>').appendTo(e).css("z-index",2*z),q=e.width(),t=0,N,al=o.data("coverStartItem"),v=o.data("coverflowFade")===false?false:true,s=o.data("background"),aa=al!==undefined?parseInt(al)-1:z%2===0?z/2-1:(z+1)/2-1,ap=s?getRGB(s):getRGB(d("body").css("background-color")),ae,x=document.createElement("canvas").getContext?true:false,X=d(window);for(var an=0;an<z;an++){if(t<aq.eq(an)[0].height){t=aq.eq(an)[0].height;N=t}}if(x){t=(1.5*t)|0;e.height(t)}else{e.height(t+20)}var Q=[],B=[],ao=[],H=[],u=[],D=[],J=[],Y=[],ah=aq[aa].width,ai=[],U=[],y=[];function am(){U=[];y=[];if(x){var av=z,az,ay,aw,ax,au;while(av--){au=j.find("li").eq(av).data("id")-1;ao[av]=aq[au].width;H[av]=aq[au].height;Q[av]=d('<canvas class="cover"/>').data("index",av);U[av]=Q[av][0];B[av]=Q[av][0].getContext("2d");Q[av][0].width=ao[av];Q[av][0].height=(1.5*H[av])|0;u[av]=new Plane(ao[av],Q[av][0].height,300,B[av],"#666",ap,aq[au]);if(av<aa){az=av;u[av].rotation.y=Math.PI/4;u[av].position.z=100;u[av].render();D[av]=u[av].maxwidth;J[av]=u[av].maxoffset;aw=D[av];ay=q/2-Q[av][0].width/2-ah/2-D[av]/2+(av-aa+1)*40+J[av]/2;ax=q/2-aw/2-ah/2-aw/2+(av-aa+1)*40}else{if(av>aa){az=z-1-av;u[av].rotation.y=-Math.PI/4;u[av].position.z=100;u[av].render();D[av]=u[av].maxwidth;J[av]=u[av].maxoffset;aw=D[av];ay=q/2-Q[av][0].width/2+ah/2+D[av]/2+(av-aa-1)*40-J[av]/2;ax=q/2+ah/2+(av-aa-1)*40}else{if(av===aa){az=av;ay=q/2-ah/2;u[av].rotation.y=Math.PI/4;u[av].position.z=100;u[av].render();D[av]=u[av].maxwidth;J[av]=u[av].maxoffset;u[av].rotation.y=0;u[av].position.z=0;u[av].render();aw=ao[av];ax=q/2-aw/2}}}Q[av].css({zIndex:az,left:ay,top:N-H[av],bottom:"auto"});ai[av]={posZ:u[av].position.z,rotY:u[av].rotation.y,cover:u[av]};Y[av]=d('<a class="coverclick"/>').data("index",av);y[av]=Y[av][0];Y[av].css({left:ax,top:N-H[av],bottom:"auto",zIndex:z+2+az,width:aw,height:Q[av][0].height})}W.append(U);e.append(y)}else{var av=z,ay,az,au;while(av--){au=j.find("li").eq(av).data("id")-1;ao[av]=aq.eq(au)[0].width;H[av]=aq.eq(au)[0].height;Q[av]=d('<div class="cover"/>').data("index",av).append(aq.eq(au).clone());U[av]=Q[av][0];D[av]=Math.round(0.7*ao[av]);if(av<aa){ay=q/2-ah/2-D[av]+(av-aa)*40;az=av;Q[av].width(D[av]);Q[av].height(Math.round(D[av]*H[av]/ao[av]))}else{if(av>aa){ay=q/2+ah/2+(av-aa)*40;az=z-1-av;Q[av].width(D[av]);Q[av].height(Math.round(D[av]*H[av]/ao[av]))}else{if(av===aa){ay=q/2-ah/2;az=av;Q[av].width(ao[av]);Q[av].height(H[av])}}}Q[av].css({left:ay,zIndex:az});Y[av]=d('<a class="coverclick"/>').data("index",av);y[av]=Y[av][0];Y[av].css({left:ay,bottom:0,top:"auto",zIndex:z+2+az,width:Q[av].width(),height:Q[av].height()})}W.append(U).height(t);e.append(y);I.css("bottom","0px")}}am();function r(){if(x){R.css({position:"absolute",bottom:"0",left:"0",zIndex:z+1});R[0].width=q;R[0].height=t;var av=R[0].getContext("2d"),au=av.createLinearGradient(0,0,q,0);au.addColorStop(0,"rgba("+ap.r+","+ap.g+","+ap.b+", 1.0)");au.addColorStop(0.35,"rgba("+ap.r+","+ap.g+","+ap.b+", 0.0)");au.addColorStop(0.65,"rgba("+ap.r+","+ap.g+","+ap.b+", 0.0)");au.addColorStop(1,"rgba("+ap.r+","+ap.g+","+ap.b+", 1.0)");av.fillStyle=au;av.rect(0,0,q,t);av.fill()}}v&&r();aq.hide();W.fadeIn(600);ae=j.find("li").eq(aa).addClass("active").data("id");Y[aa].addClass("active");I[0].innerHTML=w.eq(aa).find("title").text();var Z=d("#scrollbar-track"),ar=Z.find(".ui-slider-handle"),L=ar.wrap('<div class="ui-handle-helper-parent"/>').parent();Z.slider({animate:true,max:z-1,min:0,value:aa,slide:function(au,av){T(av.value)}});L.width(Z.width()-ar.width());d("#next").click(function(){Z.slider("value",aa+1);T(aa+1)});d("#prev").click(function(){Z.slider("value",aa-1);T(aa-1)});d(document).keydown(function(av){var au=av.keyCode||av.charCode;if(au===39){if(af.is(":visible")||k.is(":visible")){return}Z.slider("value",aa+1);T(aa+1)}else{if(au===37){if(af.is(":visible")||k.is(":visible")){return}Z.slider("value",aa-1);T(aa-1)}else{if(au===13){if(af.is(":visible")||k.is(":visible")){return}j.find("li.active").trigger("click")}else{if(au===27){O.trigger("click")}}}}});e.delegate("a.coverclick","click",function(){var av=d(this),au=av.data("index");if(av.hasClass("active")){j.find("li").eq(au).trigger("click")}else{if(au!==aa){Z.slider("value",au);T(au)}}});e.mousewheel(function(au,av){av=-Math.round(av);if(av!==0){Z.slider("value",aa+av);T(aa+av)}});var C=false;e.hover(function(){C=true},function(){C=false});d(window).mousewheel(function(){if(C){return false}});j.delegate("li","click",function(){var aw=d(this),au=aw.index(),ax="coverflow";if(aw.hasClass("active")){var av=w.eq(au).find("link").text();if(av){window.location.href=av}else{ag(ax,aw.data("type"),w.eq(aw.data("id")-1).find("source"),aw.find("h2")[0].innerHTML,aw.find("p")[0].innerHTML)}}else{if(au!==aa){aw.addClass("active").siblings().removeClass("active");Z.slider("value",au);T(au)}}});function V(){var av=j.find("li"),au=av.filter("[data-id="+ae+"]");if(au.length===1){av.removeClass("active");au.addClass("active")}else{if(au.length===0){au=av.eq(0);au.addClass("active");ae=au.data("id")}}W.empty();e.find("a.coverclick").remove();aa=av.index(au);z=av.length;ah=aq.eq(ae-1)[0].width;am();R.css("z-index",z+1);Y[aa].addClass("active");Z.slider("option","max",z-1);Z.slider("option","value",aa);I[0].innerHTML=w.eq(ae-1).find("title").text()}X.resize(function(){if(e.is(":hidden")){c.css({position:"absolute",top:0,left:0,display:"block",opacity:0});q=e.width();c.css({position:"static",display:"none",opacity:1})}else{q=e.width()}W.empty();e.find("a.coverclick").remove();ah=aq.eq(ae-1)[0].width;am();r();Y[aa].addClass("active")});d.easing.easeOutQuint=function(av,aw,au,ay,ax){return ay*((aw=aw/ax-1)*aw*aw*aw*aw+1)+au};function T(au){if(au>=0&&au<z){var ax=z;ae=j.find("li").removeClass("active").eq(au).addClass("active").data("id");Y[aa].removeClass("active");Y[au].addClass("active");I[0].innerHTML=w.eq(ae-1).find("title").text();if(x){d.fx.interval=25;var aB,av,ay,aA,aC,aw;while(ax--){if(ax<au){aB=ax;av=q/2-Q[ax][0].width/2-ao[au]/2-D[ax]/2+(ax-au+1)*40+J[ax]/2;ay=D[ax];aA=q/2-ay/2-ao[au]/2-ay/2+(ax-au+1)*40;aC=100;aw=Math.PI/4}else{if(ax>au){aB=z-1-ax;av=q/2-Q[ax][0].width/2+ao[au]/2+D[ax]/2+(ax-au-1)*40-J[ax]/2;ay=D[ax];aA=q/2-ay/2+ao[au]/2+ay/2+(ax-au-1)*40;aC=100;aw=-Math.PI/4}else{if(ax===au){aB=z;av=q/2-Q[au][0].width/2;ay=ao[au];aA=q/2-ay/2;aC=0;aw=0}}}Q[ax].css("zIndex",aB);Y[ax].css({zIndex:z+2+aB,width:ay,left:aA});Q[ax].stop(true,true).animate({left:av},1200,"easeOutQuint");d(ai[ax]).stop();if(ax===aa||ax===au){ai[ax]={posZ:u[ax].position.z,rotY:u[ax].rotation.y,cover:u[ax]};d(ai[ax]).animate({posZ:aC,rotY:aw},{duration:1200,easing:"easeOutQuint",step:function(aE,aD){if(aD.prop==="posZ"){this.cover.position.z=aE}else{this.cover.rotation.y=aE;this.cover.render()}}})}else{if(u[ax].position.z!==aC||u[ax].rotation.y!==aw){u[ax].position.z=aC;u[ax].rotation.y=aw;u[ax].render()}}}}else{var aB,av,ay,az;while(ax--){if(ax<au){av=q/2-ao[au]/2-D[ax]+(ax-au)*40;aB=ax;ay=D[ax];az=Math.round(D[ax]*H[ax]/ao[ax])}else{if(ax>au){av=q/2+ao[au]/2+(ax-au)*40;aB=z-1-ax;ay=D[ax];az=Math.round(D[ax]*H[ax]/ao[ax])}else{if(ax===au){av=q/2-ao[au]/2;aB=z;ay=ao[ax];az=H[ax]}}}Q[ax].css("zIndex",aB);Y[ax].css({zIndex:z+2+aB,width:ay,height:az,left:av});Q[ax].stop(true,true).animate({left:av,width:ay,height:az},600)}}aa=au}d(ai).promise().done(function(){d.fx.interval=16})}var p=d('<div id="mask"/>').appendTo("body"),E=d('<div id="overlayLoader"/>').appendTo("body"),af=d('<div id="overlay"/>').appendTo("body"),G=d('<div id="overlayContent"/>').appendTo(af),O=d('<a id="close"/>').appendTo(af),ab=d('<a id="prev-item"/>').appendTo(af),ak=d('<a id="next-item"/>').appendTo(af),ac;G.html('<div class="details"><h2></h2><p></p></div>');var at=G.find("h2"),K=G.find("p");function ag(az,av,au,ay,aw){d.data(af[0],"mode",az);at[0].innerHTML=ay;K[0].innerHTML=aw;var ax=X.scrollTop()+X.height()/2;p.css("height",d(document).height()).fadeIn(400,function(){E.css("top",ax).show();if(av==="photo"){if(i){af.css({visibility:"hidden",display:"block"});G.css({visibility:"hidden",display:"block"})}var aC=d('<img src="'+au.text()+'" alt="" />').appendTo(G);aC[0].onload=function(){F(aC[0]);if(i){af.css({visibility:"visible",display:"none"});G.css({visibility:"visible",display:"none"})}ad(aC[0].width,aC[0].height+80,ax)}}else{if(av==="audio"){var aE='<audio controls preload="auto">',aL='<audio controls preload="auto"';for(var aF=0,aH=au.length;aF<aH;aF++){var aD=au.eq(aF).text(),aN=aD.split(".").pop();if(aN==="ogg"){aE+='<source type="audio/ogg" src="'+aD+'" />'}else{if(aN==="mp3"){aE+='<source type="audio/mpeg" src="'+aD+'" />';aL+='type="audio/mpeg" src="'+aD+'"></audio>'}}}aE+="</audio>";if(d.browser.safari){G.append(aL)}else{G.append(innerShiv(aE))}if(X.width()<=480){ad(X.width()-80,110,ax)}else{ad(400,110,ax)}}else{if(av==="video"){var aK=600,aI=338;if(X.width()<=680){aK=X.width()-80;aI=aK*(338/600)}if(au.eq(0).text().indexOf("youtube")!==-1){var aM=au.eq(0).text().split("v=")[1],aJ=f?"&autoplay=1":"",aB='<iframe width="'+aK+'" height="'+aI+'" src="http://www.youtube.com/embed/'+aM+"?hd=1&rel=0"+aJ+'" frameborder="0" allowfullscreen></iframe>';G.append(aB)}else{if(au.eq(0).text().indexOf("vimeo")!==-1){var aM=au.eq(0).text().split("/").pop(),aA=f?"&autoplay=1":"",aB='<iframe src="http://player.vimeo.com/video/'+aM+"?"+aA+'" width="'+aK+'" height="'+aI+'" frameborder="0" webkitAllowFullScreen allowFullScreen></iframe>';G.append(aB)}else{var aB='<video controls preload="auto" width="'+aK+'" height="'+aI+'">',aG='<video controls preload="auto" width="'+aK+'" height="'+aI+'"';for(var aF=0,aH=au.length;aF<aH;aF++){var aD=au.eq(aF).text(),aN=aD.split(".").pop();if(aN==="mp4"){aB+='<source type="video/mp4" src="'+aD+'" />';aG+='type="video/mp4" src="'+aD+'"></video>'}else{if(aN==="webm"){aB+='<source type="video/webm" src="'+aD+'" />'}else{if(aN==="ogv"){aB+='<source type="video/ogg" src="'+aD+'" />'}}}}aB+="</video>";if(d.browser.safari){G.append(aG)}else{G.append(innerShiv(aB))}}}ad(aK,aI+80,ax)}}}})}function ad(au,ay,az){var ax=-(ay+40)/2,aw=-(au+40)/2,aA=d.data(af[0],"mode"),av=aA==="coverflow"?aa:aj;if(av===0){ab.hide();ak.show()}else{if(av===z-1){ab.show();ak.hide()}else{ab.show();ak.show()}}E.hide();af.css({width:au,height:ay,top:az,marginTop:ax,marginLeft:aw}).slideDown(600,function(){G.fadeIn(400).find("audio,video").mediaelementplayer({audioWidth:au,videoWidth:au,videoHeight:ay-80,loop:h,success:function(aB,aC){if(a){ac=aB;IE7.recalc()}if(f){aB.play()}}})})}ab.click(function(){var av=d.data(af[0],"mode"),au=av==="coverflow"?aa:aj;if(au-1<0){return}G.hide().children().not("div.details").remove();af.hide();if(ac){ac.pause();ac=""}if(av==="coverflow"){Z.slider("value",aa-1);T(aa-1);j.find("li").eq(aa).trigger("click")}else{l.find("img").eq(aj-1).trigger("click")}});ak.click(function(){var av=d.data(af[0],"mode"),au=av==="coverflow"?aa:aj;if(au+1===z){return}G.hide().children().not("div.details").remove();af.hide();if(ac){ac.pause();ac=""}if(av==="coverflow"){Z.slider("value",aa+1);T(aa+1);j.find("li").eq(aa).trigger("click")}else{l.find("img").eq(aj+1).trigger("click")}});O.click(function(){G.fadeOut(400,function(){af.slideUp(600,function(){if(ac){ac.pause();ac=""}G.children().not("div.details").remove();p.fadeOut(400)})})});function F(av){var ay=X.width()-120,aw=X.height()-200,ax=ay/aw,au=av.width/av.height;if(av.width>ay||av.height>aw){if(au===ax){av.width=ay;av.height=aw}else{av.width=aw*au;av.height=aw;if(av.width>ay){av.width=ay;av.height=ay/au}}}}}});function getRGB(c){var e,d,a;if(c.indexOf("#")===0){if(c.length===4){e=c.substring(1,4).substring(0,1);e=parseInt(e+e,16);d=c.substring(1,4).substring(1,2);d=parseInt(d+d,16);a=c.substring(1,4).substring(2,3);a=parseInt(a+a,16)}else{e=parseInt(c.substring(1,7).substring(0,2),16);d=parseInt(c.substring(1,7).substring(2,4),16);a=parseInt(c.substring(1,7).substring(4,6),16)}}else{if(c.indexOf("rgb")===0){e=c.split("(")[1].split(",")[0];d=c.split("(")[1].split(",")[1];a=c.split("(")[1].split(",")[2].split(")")[0]}}return{r:e,g:d,b:a}}function Plane(b,g,c,h,d,i,f){this.width=b;this.height=g;this.focalLength=c;this.ctx=h;this.color=d;this.rotation={x:0,y:0,z:0,parent:this};this.position={x:0,y:0,z:0};this.canvas=this.ctx.canvas;this.cWidth=this.canvas.width;this.cHeight=this.canvas.height;this.centerx=this.cWidth/2;this.centery=this.cHeight/2;this.maxX=0;this.minX=0;this.maxY=0;this.minY=0;this.maxwidth=0;this.maxheight=0;this.maxoffset=0;this.vertexPoints=[make3DPoint(-this.width/2,this.height/2,0),make3DPoint(this.width/2,this.height/2,0),make3DPoint(this.width/2,-this.height/2,0),make3DPoint(-this.width/2,-this.height/2,0)];this.offctx=document.createElement("canvas").getContext("2d");this.offctx.canvas.width=this.width;this.offctx.canvas.height=this.height;this.offctx.drawImage(f,0,0,f.width,f.height,0,0,f.width,f.height);this.offctx.scale(1,-1);this.offctx.translate(0,-f.height);this.offctx.drawImage(f,0,0,f.width,f.height,0,-f.height,f.width,f.height);this.offctx.scale(1,-1);var e=0.5*f.height,a=this.offctx.createLinearGradient(0,0,0,e);a.addColorStop(0,"rgba("+i.r+","+i.g+","+i.b+", 0.5)");a.addColorStop(1,"rgba("+i.r+","+i.g+","+i.b+", 1.0)");this.offctx.fillStyle=a;this.offctx.rect(0,0,f.width,e);this.offctx.fill()}Plane.prototype.render=function(){var e=Transform3DTo2D(this.vertexPoints,this.rotation,this.position,this.focalLength,this.centerx,this.centery),f=document.createElement("canvas").getContext("2d");f.canvas.width=this.width;f.canvas.height=this.height;this.ctx.clearRect(this.minX,this.minY,this.maxwidth,this.maxheight);var c=[e[0],e[1],e[3],e[2]];mapTexture(f,c,this.offctx.canvas);this.ctx.drawImage(f.canvas,0,0);var b=Math.max,d=Math.min,a=Math.abs;this.maxX=(b(e[0].x,e[1].x,e[2].x,e[3].x)+1)|0;this.minX=d(e[0].x,e[1].x,e[2].x,e[3].x)|0;this.maxY=(b(e[0].y,e[1].y,e[2].y,e[3].y)+1)|0;this.minY=d(e[0].y,e[1].y,e[2].y,e[3].y)|0;this.maxwidth=this.maxX-this.minX;this.maxheight=this.maxY-this.minY;this.maxoffset=((a((e[0].x-0)-(this.cWidth-e[1].x)))+0.5)|0};function make3DPoint(a,c,b){return{x:a,y:c,z:b}}function make2DPoint(a,b){return{x:a,y:b}}function Transform3DTo2D(w,j,D,h,u,t){var k=[],A=Math.sin,a=Math.cos,r=A(j.x),e=a(j.x),p=A(j.y),d=a(j.y),o=A(j.z),b=a(j.z),n,m,l,g,f,s,q,C,B,c;var v=w.length;while(v--){n=w[v].x;m=w[v].y;l=w[v].z;g=e*m-r*l;f=r*m+e*l;q=d*f+p*n;s=-p*f+d*n;C=b*s-o*g;B=o*s+b*g;n=C+D.x;m=B+D.y;l=q+D.z;c=h/(h+l);n=n*c+u;m=-(m*c)+t;k[v]={x:n,y:m}}return k};

/*
 * Projective texturing using Canvas.
 * (c) Steven Wittens 2008
 * http://www.acko.net/
 */

/*
 * Modified by Nilok Bose, (c) 2012
 * http://codecanyon.net/user/cosmocoder
 */

function mapTexture(j,i,e){var h=3,g=28,b=getProjectiveTransform(i);var d=b.transformProjectiveVector([0,0,1]),a=b.transformProjectiveVector([1,0,1]),f=b.transformProjectiveVector([0,1,1]),c=b.transformProjectiveVector([1,1,1]);j.save();j.beginPath();j.moveTo(d[0],d[1]);j.lineTo(a[0],a[1]);j.lineTo(c[0],c[1]);j.lineTo(f[0],f[1]);j.closePath();j.clip();divide(0,0,1,1,d,a,f,c,b,h,g,j,e);j.restore()}function divide(o,W,m,V,U,T,S,Q,x,u,l,s,h){var C=Math.abs,B=Math.max,g=Math.min,q=Math.sqrt;if(u){var M=[T[0]+S[0]-2*U[0],T[1]+S[1]-2*U[1]],K=[T[0]+S[0]-2*Q[0],T[1]+S[1]-2*Q[1]],I=[M[0]+K[0],M[1]+K[1]],E=C((I[0]*I[0]+I[1]*I[1])/(M[0]*K[0]+M[1]*K[1]));M=[T[0]-U[0]+Q[0]-S[0],T[1]-U[1]+Q[1]-S[1]];K=[S[0]-U[0]+Q[0]-T[0],S[1]-U[1]+Q[1]-T[1]];var A=C(M[0]*K[1]-M[1]*K[0]);if((o===0&&m===1)||((0.25+E*5)*A>(l*l))){var c=(o+m)/2,w=(W+V)/2,a=x.transformProjectiveVector([c,w,1]),i=x.transformProjectiveVector([c,W,1]),t=x.transformProjectiveVector([c,V,1]),p=x.transformProjectiveVector([o,w,1]),j=x.transformProjectiveVector([m,w,1]);--u;divide(o,W,c,w,U,i,p,a,x,u,l,s,h);divide(c,W,m,w,i,T,a,j,x,u,l,s,h);divide(o,w,c,V,p,a,S,t,x,u,l,s,h);divide(c,w,m,V,a,j,t,Q,x,u,l,s,h);return}}s.save();s.beginPath();s.moveTo(U[0],U[1]);s.lineTo(T[0],T[1]);s.lineTo(Q[0],Q[1]);s.lineTo(S[0],S[1]);s.closePath();var P=[T[0]-U[0],T[1]-U[1]],y=[Q[0]-T[0],Q[1]-T[1]],R=[S[0]-Q[0],S[1]-Q[1]],k=[U[0]-S[0],U[1]-S[1]];var H=C(P[0]*k[1]-P[1]*k[0]),G=C(y[0]*P[1]-y[1]*P[0]),D=C(R[0]*y[1]-R[1]*y[0]),F=C(k[0]*R[1]-k[1]*R[0]),n=B(B(H,G),B(F,D)),d=0,b=0,L=0,J=0;switch(n){case H:s.transform(P[0],P[1],-k[0],-k[1],U[0],U[1]);if(m!==1){L=1.05/q(P[0]*P[0]+P[1]*P[1])}if(V!==1){J=1.05/q(k[0]*k[0]+k[1]*k[1])}break;case G:s.transform(P[0],P[1],y[0],y[1],T[0],T[1]);if(m!==1){L=1.05/q(P[0]*P[0]+P[1]*P[1])}if(V!==1){J=1.05/q(y[0]*y[0]+y[1]*y[1])}d=-1;break;case D:s.transform(-R[0],-R[1],y[0],y[1],Q[0],Q[1]);if(m!==1){L=1.05/q(R[0]*R[0]+R[1]*R[1])}if(V!==1){J=1.05/q(y[0]*y[0]+y[1]*y[1])}d=-1;b=-1;break;case F:s.transform(-R[0],-R[1],-k[0],-k[1],S[0],S[1]);if(m!==1){L=1.05/q(R[0]*R[0]+R[1]*R[1])}if(V!==1){J=1.05/q(k[0]*k[0]+k[1]*k[1])}b=-1;break}var f=(m-o),e=(V-W),O=L*f,N=J*e;var v=h.width,z=h.height;s.drawImage(h,o*v,W*z,g(m-o+O,1)*v,g(V-W+N,1)*z,d,b,1+L,1+J);s.restore()}function getProjectiveTransform(b){var c=new Matrix(9,8,[[1,1,1,0,0,0,-b[3].x,-b[3].x,-b[3].x],[0,1,1,0,0,0,0,-b[2].x,-b[2].x],[1,0,1,0,0,0,-b[1].x,0,-b[1].x],[0,0,1,0,0,0,0,0,-b[0].x],[0,0,0,-1,-1,-1,b[3].y,b[3].y,b[3].y],[0,0,0,0,-1,-1,0,b[2].y,b[2].y],[0,0,0,-1,0,-1,b[1].y,0,b[1].y],[0,0,0,0,0,-1,0,0,b[0].y]]);var d=c.rowEchelon().values;var a=new Matrix(3,3,[[-d[0][8],-d[1][8],-d[2][8]],[-d[3][8],-d[4][8],-d[5][8]],[-d[6][8],-d[7][8],1]]);return a};


/*
 * Generic matrix class.
 * (c) Steven Wittens 2008
 * http://www.acko.net/
 */

/*
 * Modified by Nilok Bose, (c) 2012
 * http://codecanyon.net/user/cosmocoder
 */

var Matrix=function(a,c,b){this.w=a;this.h=c;this.values=b||Matrix.allocate(c)};Matrix.allocate=function(a,e){var b=[],d=e,c=a;while(d--){b[d]=[];while(c--){b[d][c]=0}}return b};Matrix.cloneValues=function(b){clone=[];for(var c=0,a=b.length;c<a;++c){clone[c]=[].concat(b[c])}return clone};Matrix.prototype.transformProjectiveVector=function(b){var c=[];for(var e=0;e<this.h;++e){c[e]=0;for(var a=0;a<this.w;++a){c[e]+=this.values[e][a]*b[a]}}var d=1/(c[c.length-1]);for(var e=0;e<this.h;++e){c[e]*=d}return c};Matrix.prototype.rowEchelon=function(){if(this.w<=this.h){throw"Matrix rowEchelon size mismatch"}var h=Matrix.cloneValues(this.values);for(var a=0;a<this.h;++a){var f=h[a][a];while(f==0){for(var g=a+1;g<this.h;++g){if(h[g][a]!=0){var i=h[g];h[g]=h[a];h[a]=i;break}}if(g==this.h){return new Matrix(this.w,this.h,h)}else{f=h[a][a]}}var b=1/f;for(var e=a;e<this.w;++e){h[a][e]*=b}for(var d=0;d<this.h;++d){if(d==a){continue}var c=h[d][a];h[d][a]=0;for(var e=a+1;e<this.w;++e){h[d][e]-=c*h[a][e]}}}return new Matrix(this.w,this.h,h)};